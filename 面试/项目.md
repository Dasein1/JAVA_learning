# 高并发秒杀项目
## 1.发现容量问题的本质：什么样的系统是高性能系统？
能够承载高并发，并且能够快速的返回
### 机器性能理解：
    1.找到java的进出   ps -f |grep java
    2.用pstrea -p xxxx | wc -l 查看该进程下有多少线程数量
    3.top -H 查看机器性能
        关注几个指标
        cpu: 
            us:用户态下对cpu的占用
            sy:内核态对cpu的占用（当我们发起系统调用，使用socket.write,socket.read）
            load average:2核则若超过2则表示cpu很忙
            比如说写一个while（true）的死循环，会造成cpu的us 100%，但是对应的load并不是很高，这是因为cpu即便在运转但并没有做一些很耗时的操作比如说socketIO的read和send、文件的读和写，所以最需要关注load的值
                load很高说明CPU运算很忙
                load+cpu都很高说明有问题

### Jmeter压测：
    1.10秒钟内启动500个线程，每个线程压10次  TPS 200多  Average  467    压力基本都在数据库上，应用程序相对来说没有做太多事情
    1.10秒钟内启动5000个线程，每个线程压100次
        Erro 97%   java.net.SocketException:Too many open files at java.net.Socket.createImpl
        通过pstree -p 5240 | wc -l发现改该进程最多只能服务42个线程
    2.找到并发上不去的一个原因：server配置有问题导致线程开不出来导致客户端被拒接连接
    解决：3.服务端在上线前一定要将容器的配置，线程池的配置，连接数的配置全都检查一遍以保证在生产环境下是最优的
    4.15秒钟内启动2000个线程，每个线程压100次
        Average 2266  TPS 200
        压测前  线程数量118   压测后线程数量  472
    5.15秒钟内启动400个线程，每个线程压50次
        TPS 225   Average 424  单台机器
    6.使用对应工厂类提供给我们的接口定制化我们的tomcat connector 定制化tomcat容器的设置
        为什么使用keepalive？
			原因：http协议的keepalive请求为当我们的客户端向我们的服务器发送http请求时，若带上了对应的http请求头，则表明我们的http客户端希望跟服务端建立一个keepalive的连接，解决每次服务端发送完请求响应都要断开链接所产生的耗时问题
			缺陷：1.用户搁置网页2.被人利用Keepalive做DDOS攻击
			解决：定制化内嵌Tomcat开发
				keppAliveTimeOut:多少毫秒后客户端不响应则断开keepalive
				maxKeepAliveRequests：多少次请求后keepalive断开失效
				在spring-configuration-metadata.json中没有上述两个配置
			使用WebServerFactoryCustomizer<ConfigurableServletWebServerFactory> 定制化内嵌tomcat配置
				当springboot启动之后，会将application.properties中的server.tomcat的参数加载到对应的protocol
				设置30秒内没有请求则服务端自动断开keepalive链接
                当客户端发送超过10000个请求则自动断开keepalive链接

## 2. 分布式扩展
    1.10秒钟内启动200个线程，每个线程压20次
        TPS涨到230左右上不去 Average也在不断增加
    2.nginx反向代理后
        
        提升单机带宽 压力发给单机 5秒钟内启动1000个线程，每个线程压30次
            Average 450  TPS 1500   cpu 80%  load也很高
        
        压力发给 nginx反向代理
          Average   4501  1723   cpu 不到20%  
        
        默认Nginx和应用服务器是短连接(降低average 平均耗时)，需要改为长连接


## 3.多级缓存
    4000TPS  Average 150